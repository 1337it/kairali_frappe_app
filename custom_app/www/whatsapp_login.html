{% extends "templates/web.html" %}

{% block page_content %}
<div class="container text-center mt-5">
    <h2>WhatsApp OTP Login</h2>
    <input input type="tel" inputmode="numeric" pattern="[0-9]*" id="number" placeholder="Enter WhatsApp Number" class="form-control my-2">
    <button class="btn btn-primary" onclick="sendOTP()">Send OTP</button>
    
    <div class="mt-3" id="otp-section" style="display:none;">
        <input input type="tel" inputmode="numeric" pattern="[0-9]*" id="otp" placeholder="Enter OTP" class="form-control my-2">
        <button class="btn btn-success" onclick="verifyOTP()">Verify & Login</button>
    </div>
</div>

<script>
function sendOTP(){
    let number = document.getElementById('number').value;
    frappe.call({
        method: 'frappe_whatsapp_login.api.send_otp',
        args: {number},
        callback: function(r){
            if(r.message.status === 'success'){
                document.getElementById('otp-section').style.display = 'block';
                alert('OTP sent to WhatsApp!');
            } else {
                alert(r.message.message);
            }
        }
    });
}

function verifyOTP(){
    let number = document.getElementById('number').value;
    let otp = document.getElementById('otp').value;
    frappe.call({
        method: 'frappe_whatsapp_login.api.verify_otp',
        args: {number, otp},
        callback: function(r){
            if(r.message.status === 'success'){
                window.location.href = '/app'; // Redirect to Desk
            } else {
                alert(r.message.message);
            }
        }
    });
}
</script>
{% endblock %}
